<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>תרגיל</title>

<!-- MathJax v3 -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)']],
      displayMath: [['\\[','\\]']],
      packages: {'[+]':['noerrors']}
    },
    loader: { load: ['[tex]/noerrors'] },
    chtml: { scale: 1.02, mtextInheritFont: true }
  };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<!-- mathjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>

<style>
  :root{
    --bg:#0e1424; --panel:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
    --ring:#334155; --accent:#60a5fa; --ok:#34d399; --bad:#ef4444;
    --field:#1f2a3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;direction:rtl}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font-family:'Segoe UI','Tahoma','Arial','David','FrankRuehl',serif;text-align:right;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:22px}
  h1{font-size:1.35rem;margin:0 0 16px}

  .grid{display:grid;grid-template-columns:1fr 1.2fr;gap:16px}
  @media (max-width:920px){.grid{grid-template-columns:1fr}}

  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px 16px}
  .section-title{font-size:1.05rem;margin:0 0 10px;color:var(--ink)}

  label{font-size:.92rem;color:var(--muted);display:block}
  textarea{
    width:100%;background:var(--field);color:var(--ink);
    border:1px solid var(--ring);border-radius:12px;
    padding:10px 12px;font-size:1rem;line-height:1.5;outline:none;
    direction:ltr;text-align:left;font-family:monospace;
  }
  textarea:focus{border-color:var(--accent)}

  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px;justify-content:flex-start}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:var(--field);padding:6px 10px;border-radius:999px;font-size:.9rem}
  .btn{cursor:pointer;background:var(--field);border:1px solid var(--ring);color:var(--ink);padding:8px 12px;border-radius:10px}
  .btn:hover{border-color:var(--accent)}

  .status{font-size:.9rem;margin-top:6px;text-align:right}
  .status.ok{color:var(--ok)} .status.bad{color:var(--bad)}

  .render{
    background:#0b1020;border:1px dashed #243047;border-radius:12px;
    padding:14px 16px;min-height:96px;overflow:auto;direction:ltr;text-align:center;
  }
  .hint{color:var(--muted);font-size:.9rem;margin-top:8px}
  .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  select{background:var(--field);color:var(--ink);border:1px solid var(--ring);border-radius:10px;padding:6px 8px}
  .debug{display:none}
</style>
</head>
<body>
  <div class="wrap">
    <h1>תרגיל</h1>

    <div class="grid">
      <!-- ימין: השאלה -->
      <aside class="card">
        <div class="section-title">השאלה</div>
        <div id="problemRender" class="render"></div>
      </aside>

      <!-- שמאל: תשובת הסטודנטים -->
      <section class="card">
        <div class="section-title">הזינו כאן את התשובה הסופית</div>

        <label for="inputRaw">קלט Plain או LaTeX</label>
        <textarea id="inputRaw" rows="6"
placeholder="דוגמה ב-LaTeX
y = C_1 e^{2x}\sin x + C_2 e^{2x}\cos x + x^{2} - 3x + 5"></textarea>

        <div class="controls">
          <span class="pill"><input type="checkbox" id="forceLatex"><label for="forceLatex" style="margin:0">כפיית מצב LaTeX</label></span>
          <button class="btn" id="btnClear">ניקוי</button>
          <button class="btn" id="btnCheck">בדיקת תשובה</button>
          <span class="pill">מצב בדיקה
            <select id="checkMode">
              <option value="general" selected>פתרון כללי</option>
              <option value="exact">ביטוי מדויק</option>
              <option value="ode">מספק את המשוואה</option>
            </select>
          </span>
        </div>

        <div id="status" class="status"></div>

        <label style="margin-top:10px;display:block">תצוגה</label>
        <div id="render" class="render"></div>

        <div id="checkMsg" class="status" style="margin-top:10px"></div>

        <div class="hint">
          • בדיקת נכונות פועלת בקלט Plain<br/>
          • הטקסט במסך אינו פתרון התרגיל אלא דוגמה לכתיבת משוואה ב-LaTeX<br/>
          • הציגו קבועים באותיות גדולות לדוגמה: A, B, C, D, K או C_1, C_2, D_1, D_2 • ניתן להשתמש ב: C*exp(x), C*e^x, או Ce^x
        </div>
      </section>
    </div>
  </div>

<script>
// הגנה מריצה כפולה
if (!window.exerciseInitialized) {
  window.exerciseInitialized = true;

  function waitForLibraries(cb){
    let tries=0;
    (function check(){
      if (typeof math !== 'undefined' && window.MathJax) cb();
      else if(tries++<100) setTimeout(check,50);
      else console.error('Libraries failed to load');
    })();
  }

  waitForLibraries(function(){

    // ===== refs =====
    const inputEl = document.getElementById('inputRaw');
    const forceLatexEl = document.getElementById('forceLatex');
    const btnClear = document.getElementById('btnClear');
    const btnCheck = document.getElementById('btnCheck');
    const checkModeEl = document.getElementById('checkMode');

    // ===== utils =====
    function sanitizeBasic(s){ return (s||'').replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g,'').trim() }
    function looksLikeLatex(s){ return /\\[a-zA-Z]+|\\\[|\\\]|\\\(|\\\)|\$(?!\s*$)|\\int|\\sum|\\frac|\\sqrt/.test(s) }
    function escapeHtml(str){ return (str||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // מזהים עם אותיות/ספרות/קו-תחתון וכפל סמוי
    function insertImplicitMult(s){
      const id = '([A-Za-z](?:[A-Za-z0-9_]*))';
      s = s.replace(new RegExp(id + '\\s*(?=\\()', 'g'), '$1*');                          // var( → var*(
      s = s.replace(new RegExp(id + '\\s*(?=\\b[xX]\\b)', 'g'), '$1*');                  // var x → var*x
      s = s.replace(new RegExp(id + '\\s*e\\s*\\^', 'g'), '$1*e^');                       // var e^x → var*e^x
      s = s.replace(new RegExp(id + '\\s*(?=\\b(?:sin|cos|tan|asin|acos|atan|exp|log|ln|sqrt|abs)\\b)', 'g'), '$1*'); // var sin → var*sin
      return s;
    }

    function convertMathNotation(s){
      s = s.replace(/\be\s*\^\s*\(/g, 'exp(');
      s = s.replace(/\be\s*\^\s*([a-zA-Z_]\w*|[0-9]+)/g, 'exp($1)');
      s = s.replace(/\be\s*\^\s*\{([^}]+)\}/g, 'exp($1)');
      s = s.replace(/\^/g, '**');
      return s;
    }

    function normalizeToPlain(s){
      let t = sanitizeBasic(s);
      t = t.replace(/^\s*[yY]\s*(\(\s*x\s*\))?\s*=\s*/, '');
      t = t.replace(/(\d),(\d)/g,'$1.$2');
      t = insertImplicitMult(t);
      t = convertMathNotation(t);
      return t;
    }

    function setStatus(msg, cls){
      const el = document.getElementById('status');
      el.className = `status ${cls||''}`;
      el.textContent = (msg||'') + (cls==='ok' ? '  @ open university' : '');
    }

    async function renderLatexTo(containerId, latex, display=true){
      const el = document.getElementById(containerId);
      el.innerHTML = display ? `\\[ ${latex} \\]` : `\\(${latex}\\)`;
      if (window.MathJax?.typesetPromise){
        try{ await MathJax.typesetPromise([el]) }catch{ el.innerHTML = `<div class="monospace">${escapeHtml(latex)}</div>` }
      }
    }

    // ===== display processing =====
    let debTimer=null; function debounce(fn,ms=180){ clearTimeout(debTimer); debTimer=setTimeout(fn,ms) }
    async function process(){
      const raw0 = inputEl.value, raw = sanitizeBasic(raw0);
      if(!raw){ document.getElementById('render').innerHTML=''; setStatus('',''); return }
      const forced = forceLatexEl.checked, latexMode = forced || looksLikeLatex(raw);

      try{
        if(latexMode){
          await renderLatexTo('render', raw, true);
          setStatus('מעובד במצב LaTeX', 'ok');
        }else{
          const plain = normalizeToPlain(raw);
          const node = math.parse(plain);
          const latex = node.toTex({ parenthesis:'keep', implicit:'show' });
          await renderLatexTo('render', latex, true);
          setStatus('מעובד במצב Plain → LaTeX באמצעות mathjs', 'ok');
        }
      }catch(err){
        document.getElementById('render').innerHTML =
          `<div class="monospace">שגיאה בעיבוד
${escapeHtml(err?.message || String(err))}

קלט
${escapeHtml(raw)}</div>`;
        setStatus('שגיאה בעיבוד — לבדוק תחביר', 'bad');
      }
    }

    // ===== checker =====
    const basePart = "x + 1";
    const fundamental = "exp(x)";

    function dependsOnX(node){
      let dep=false; node.traverse(n=>{ if(n.isSymbolNode && n.name==='x') dep=true }); return dep
    }
    function hasFreeParamSymbolFromNode(node){
      let has=false;
      node.traverse(n=>{
        if(n.isSymbolNode){
          const nm=n.name;
          if(nm!=='x' && nm!=='e' && nm!=='pi') has=true;
        }
      });
      return has
    }
    function trySymbolicZero(expr){
      try{
        const simp = math.simplify(expr).toString().replace(/\s+/g,'');
        return simp === '0' || /^0(\*.*)?$/.test(simp)
      }catch{ return false }
    }

    function checkGeneralSolution(userRaw){
      const userSan = sanitizeBasic(userRaw);
      const user = normalizeToPlain(userSan);
      if(!user){ return false }

      try{
        const g = math.simplify(`(${user}) - (${basePart})`);
        const h = math.simplify(`(${g.toString()}) / (${fundamental})`);
        const hStr = h.toString();
        const hNode = math.parse(hStr);
        if (dependsOnX(hNode)) return false;     // חייב להיות קבוע
        if (trySymbolicZero(hStr)) return false; // לא פתרון פרטי
        if (!hasFreeParamSymbolFromNode(hNode)) return false; // חייב להיות פרמטר חופשי
        return true;
      }catch{ return false }
    }

    function checkSatisfiesODE(userRaw){
      const user = normalizeToPlain(userRaw);
      if(!user) return false;
      try{
        const du = math.derivative(user,'x').toString();
        const expr = `(${du}) - (${user}) + x`;
        return trySymbolicZero(expr);
      }catch{ return false }
    }

    let correctExprPlain = "x + 1";
    function checkExact(userRaw){
      const user = normalizeToPlain(userRaw);
      if(!user || !correctExprPlain) return false;
      return trySymbolicZero(`(${user}) - (${correctExprPlain})`);
    }

    // ===== events =====
    inputEl.addEventListener('input', ()=>debounce(process,120));
    forceLatexEl.addEventListener('change', process);

    btnClear.addEventListener('click', ()=>{
      inputEl.value='';
      document.getElementById('render').innerHTML='';
      setStatus('');
      document.getElementById('checkMsg').textContent='';
      inputEl.focus();
    });

    btnCheck.addEventListener('click', ()=>{
      const raw0 = inputEl.value;
      const raw = sanitizeBasic(raw0);
      const latexMode = looksLikeLatex(raw) && !forceLatexEl.checked;
      if(latexMode){
        document.getElementById('checkMsg').className = 'status bad';
        document.getElementById('checkMsg').textContent = 'בדיקת נכונות פועלת בקלט Plain';
        return;
      }
      const mode = checkModeEl.value;
      let ok=false;
      if(mode==='general') ok=checkGeneralSolution(raw0);
      else if(mode==='ode') ok=checkSatisfiesODE(raw0);
      else ok=checkExact(raw0);

      const el = document.getElementById('checkMsg');
      el.className = 'status ' + (ok?'ok':'bad');
      el.textContent = ok ? 'תשובה נכונה' : 'תשובה לא נכונה';
    });

    // ===== שאלה ותצוגת התחלה =====
    async function setProblem(textOrLatex, isLatex=true){
      if(isLatex) await renderLatexTo('problemRender', textOrLatex, true);
      else document.getElementById('problemRender').innerHTML = `<div>${escapeHtml(textOrLatex)}</div>`;
    }

    setProblem(String.raw`y' = y - x\quad \text{מצאו את הפתרון הכללי}`);
    inputEl.value = String.raw`y = C_1 e^{2x}\sin x + C_2 e^{2x}\cos x + x^{2} - 3x + 5`;
    process();
  });
}
</script>
</body>
</html>
