<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>תרגיל</title>

<!-- MathJax v3 -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\\(','\\)'],['$','$']],
      displayMath: [['\\[','\\]']],
      packages: {'[+]':['noerrors','noundefined']}
    },
    loader: { load: ['[tex]/noerrors','[tex]/noundefined'] },
    chtml: { scale: 1.02, mtextInheritFont: true }
  };
</script>
<script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

<!-- mathjs -->
<script src="https://cdn.jsdelivr.net/npm/mathjs@13.0.2/lib/browser/math.js"></script>

<style>
  :root{
    --bg:#0e1424; --panel:#111827; --ink:#e5e7eb; --muted:#9aa6b2;
    --ring:#334155; --accent:#60a5fa; --ok:#34d399; --bad:#ef4444;
    --field:#1f2a3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:22px}
  h1{font-size:1.35rem;margin:0 0 16px}

  .grid{
    display:grid;
    grid-template-columns: 1fr 1.2fr;
    gap:16px;
  }
  @media (max-width: 920px){
    .grid{grid-template-columns:1fr}
  }

  .card{background:var(--panel);border:1px solid var(--ring);border-radius:14px;padding:14px 16px}
  .section-title{font-size:1.05rem;margin:0 0 10px;color:var(--ink)}

  label{font-size:.92rem;color:var(--muted)}
  textarea, input[type="text"]{
    width:100%;background:var(--field);color:var(--ink);
    border:1px solid var(--ring);border-radius:12px;padding:10px 12px;font-size:1rem;line-height:1.5;outline:none
  }
  textarea:focus, input[type="text"]:focus{border-color:var(--accent)}

  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--ring);background:var(--field);padding:6px 10px;border-radius:999px;font-size:.9rem}
  .btn{cursor:pointer;background:var(--field);border:1px solid var(--ring);color:var(--ink);padding:8px 12px;border-radius:10px}
  .btn:hover{border-color:var(--accent)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--ring);background:var(--field);font-size:.8rem;color:var(--muted)}

  .status{font-size:.9rem;margin-top:6px}
  .status.ok{color:var(--ok)} .status.bad{color:var(--bad)}

  .render{background:#0b1020;border:1px dashed #243047;border-radius:12px;padding:14px 16px;min-height:96px;overflow:auto}
  .hint{color:var(--muted);font-size:.9rem;margin-top:8px}
  .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body>
  <div class="wrap">
    <h1>תרגיל</h1>

    <div class="grid">
      <!-- RIGHT: Question panel -->
      <aside class="card">
        <div class="section-title">השאלה</div>
        <div id="problemRender" class="render"></div>
        <!-- ניתן לעדכן את השאלה באמצעות setProblem(...) בקוד -->
      </aside>

      <!-- CENTER: Answer input panel -->
      <section class="card">
        <div class="section-title">הזינו כאן את התשובה הסופית</div>
        <label for="inputRaw">קלט Plain או LaTeX</label>
        <textarea id="inputRaw" rows="6" placeholder="דוגמאות
Plain:  2*sin(x)^2/(x+1), ln(x), exp(x), sqrt(1-x^2)
LaTeX:  \int_0^1 \frac{\sin x}{x}\,dx, \sum_{n=1}^\infty \frac{1}{n^2}"></textarea>

        <div class="controls">
          <span class="pill"><input type="checkbox" id="forceLatex"> <label for="forceLatex" style="margin:0">כפיית מצב LaTeX</label></span>
          <button class="btn" id="btnClear">ניקוי</button>
          <span class="badge" id="modeBadge">זיהוי מצב: auto</span>
        </div>

        <div id="status" class="status"></div>

        <label style="margin-top:10px;display:block">תצוגה</label>
        <div id="render" class="render"></div>

        <div class="hint">
          • לאינטגרלים ולסכומים מומלץ להזין LaTeX  
          • בקלט רגיל יש המרה אוטומטית של פסיקים עשרוניים לנקודות למשל 2,5 → 2.5  
          • זהו שלב תצוגה ללא בדיקת נכונות
        </div>
      </section>
    </div>
  </div>

<script>
  // Utilities כלליים
  const rtlMarks = /[\u200E\u200F\u202A-\u202E\u2066-\u2069]/g;
  const inputEl = document.getElementById('inputRaw');
  const forceLatexEl = document.getElementById('forceLatex');
  const btnClear = document.getElementById('btnClear');

  function sanitizeBasic(s){ return (s||'').replace(rtlMarks,'').trim() }
  function commaDecimalToDot(s){ return s.replace(/(\d),(\d)/g,'$1.$2') }
  function looksLikeLatex(s){
    return /\\[a-zA-Z]+|\\\[|\\\]|\\\(|\\\)|\$(?!\s*$)|\\int|\\sum|\\frac|\\sqrt/.test(s)
  }
  function escapeHtml(str){
    return (str||'').replace(/[&<>"']/g, m => (
      {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
    ))
  }
  function setStatus(msg, cls){
    const el = document.getElementById('status');
    el.className = `status ${cls||''}`;
    el.textContent = msg || ''
  }
  function setModeBadge(text){
    document.getElementById('modeBadge').textContent = `זיהוי מצב: ${text}`
  }

  async function renderLatexTo(containerId, latex, display=true){
    const el = document.getElementById(containerId);
    el.innerHTML = display ? `\\[ ${latex} \\]` : `\\(${latex}\\)`;
    if (window.MathJax?.typesetPromise){
      try{ await MathJax.typesetPromise([el]) }catch(e){ el.innerHTML = `<div class="monospace">${escapeHtml(latex)}</div>` }
    }
  }

  // עיבוד התשובה במרכז
  let debTimer=null; function debounce(fn,ms=180){ clearTimeout(debTimer); debTimer=setTimeout(fn,ms) }

  async function process(){
    const raw0 = inputEl.value;
    const raw = sanitizeBasic(raw0);
    if(!raw){
      document.getElementById('render').innerHTML=''; setStatus('',''); setModeBadge('auto'); return
    }
    const forced = forceLatexEl.checked;
    const latexMode = forced || looksLikeLatex(raw);
    setModeBadge(latexMode ? (forced ? 'LaTeX כפוי' : 'LaTeX זוהה') : 'Plain זוהה');

    try{
      if(latexMode){
        await renderLatexTo('render', raw, true);
        setStatus('מעובד במצב LaTeX', 'ok');
      }else{
        const plain = commaDecimalToDot(raw);
        const node = math.parse(plain);
        const latex = node.toTex({parenthesis:'keep', implicit:'show'});
        await renderLatexTo('render', latex, true);
        setStatus('מעובד במצב Plain → LaTeX באמצעות mathjs', 'ok');
      }
    }catch(err){
      document.getElementById('render').innerHTML =
        `<div class="monospace">שגיאה בעיבוד
${escapeHtml(err?.message || String(err))}

קלט
${escapeHtml(raw)}</div>`;
      setStatus('שגיאה בעיבוד — לבדוק תחביר. לאינטגרלים ולסכומים מומלץ LaTeX', 'bad');
    }
  }

  inputEl.addEventListener('input', ()=>debounce(process,120));
  forceLatexEl.addEventListener('change', process);
  btnClear.addEventListener('click', ()=>{
    inputEl.value=''; document.getElementById('render').innerHTML=''; setStatus('',''); setModeBadge('auto'); inputEl.focus()
  });

  // הגדרת השאלה: ניתן להעביר LaTeX או טקסט רגיל
  async function setProblem(textOrLatex, isLatex=true){
    if(isLatex){
      await renderLatexTo('problemRender', textOrLatex, true)
    }else{
      document.getElementById('problemRender').innerHTML = `<div>${escapeHtml(textOrLatex)}</div>`
    }
  }

  // שאלה ברירת מחדל
  setProblem(String.raw`\textbf{פתרו}\quad y' = y - x\quad \text{מצאו את הפתרון הכללי}`);

  // תוכן התחלתי בתיבה
  inputEl.value = "2*sin(x)^2/(x+1)";
  process();
</script>
</body>
</html>
